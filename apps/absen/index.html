<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Aplikasi Kehadiran</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* -- CSS Variables untuk Tema -- */
    :root {
      --primary-color: #00BFA6; /* Warna hijau toska modern */
      --danger-color: #F44336;
      --light-gray: #f7f8fa;
      --dark-gray: #6c757d;
      --text-color: #333;
      --border-color: #e0e0e0;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --border-radius: 12px;
    }

    /* -- Gaya Dasar & Tipografi -- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--light-gray);
      margin: 0;
      color: var(--text-color);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      padding: 20px;
    }

    h1, h2 {
      color: var(--primary-color);
      font-weight: 700;
    }
    
    h1 {
      text-align: center;
      font-size: 1.8em;
      margin-bottom: 20px;
    }
    
    h2 {
      font-size: 1.4em;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 8px;
      margin-top: 0;
      margin-bottom: 20px;
    }

    hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 30px 0;
    }

    /* -- Desain Kartu (Card) -- */
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--card-shadow);
    }
    
    /* -- Gaya Form & Input -- */
    .attendance-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }

    .attendance-item label {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark-gray);
    }

    .input-group {
      display: flex;
      gap: 10px;
    }

    .attendance-item select,
    .custom-input,
    .attendance-date-input,
    #deleteRowCount {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: #fff;
      font-size: 1em;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .attendance-item select:focus,
    .custom-input:focus,
    .attendance-date-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 191, 166, 0.2);
    }

    /* -- Gaya Tombol -- */
    button {
      width: 100%;
      padding: 12px 20px;
      font-size: 1em;
      font-weight: 600;
      color: white;
      background-color: var(--primary-color);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      margin-top: 10px;
    }

    button:hover {
      background-color: #00a794;
    }

    button:active {
      transform: scale(0.98);
    }

    button.delete-btn {
      background-color: var(--danger-color);
    }
    button.delete-btn:hover {
      background-color: #d32f2f;
    }

    /* -- Seksi Tampilkan & Hapus Data -- */
    .data-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }

    .delete-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* -- Gaya Tabel & Tabel Responsif -- */
    #tableWrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    thead th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--dark-gray);
    }

    tbody tr:nth-child(even) {
      background-color: #fdfdfd;
    }
    
    .sunday-row {
      background-color: #fff1f0 !important; /* Warna merah muda untuk hari Minggu */
      color: #cf1322;
      font-weight: 500;
    }

    /* Tampilan Tabel di Mobile (di bawah 768px) */
    @media screen and (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      /* Sembunyikan header tabel */
      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      
      tr {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-bottom: 15px;
        background: white;
        box-shadow: var(--card-shadow);
      }

      td {
        border: none;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
        padding-left: 50%;
        text-align: right;
        white-space: normal;
      }
      
      td:last-child {
        border-bottom: none;
      }

      /* Tampilkan label dari atribut data-label */
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 15px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: 600;
        color: var(--dark-gray);
      }
      
      /* Reset untuk kolom pertama (tanggal) agar lebih menonjol */
      td:first-child {
        background-color: #fafafa;
        font-weight: bold;
        text-align: center;
        padding-left: 15px;
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
      }
      
      td:first-child:before {
        content: ""; /* Sembunyikan label untuk tanggal */
      }
      
      .sunday-row td:first-child {
        background-color: #fff1f0;
      }
    }

    /* -- Lain-lain -- */
    #loading { display: none; text-align: center; color: var(--dark-gray); margin-top: 10px; }
    #error { color: var(--danger-color); margin-top: 10px; font-weight: 500; }
  </style>
</head>
<body>

<div class="container">
  <h1>✨ Aplikasi Kehadiran</h1>

  <div class="card">
    <h2>Input Kehadiran Harian</h2>
    <div class="attendance-item">
        <label for="attendanceDate">Pilih Tanggal:</label>
        <input type="date" id="attendanceDate" class="attendance-date-input">
    </div>
    <hr>
    <div id="employeeAttendanceList">
      <div class="attendance-item">
        <label>Andi Prasetyo:</label>
        <div class="input-group">
          <select id="selectAndiPrasetyo"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select>
          <input type="text" id="inputAndiPrasetyo" class="custom-input" placeholder="Keterangan...">
        </div>
      </div>
      <div class="attendance-item">
        <label>Astri Yuwana:</label>
        <div class="input-group">
          <select id="selectAstriYuwana"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select>
          <input type="text" id="inputAstriYuwana" class="custom-input" placeholder="Keterangan...">
        </div>
      </div>
       <div class="attendance-item"><label>Fredi Pradopo:</label><div class="input-group"><select id="selectFrediPradopo"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputFrediPradopo" class="custom-input" placeholder="Keterangan..."></div></div>
       <div class="attendance-item"><label>Kevin Haikal:</label><div class="input-group"><select id="selectKevinHaikal"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputKevinHaikal" class="custom-input" placeholder="Keterangan..."></div></div>
       <div class="attendance-item"><label>Laili Asmita:</label><div class="input-group"><select id="selectLailiAsmita"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputLailiAsmita" class="custom-input" placeholder="Keterangan..."></div></div>
       <div class="attendance-item"><label>Merry Ariesta Putri:</label><div class="input-group"><select id="selectMerryAriestaP"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputMerryAriestaP" class="custom-input" placeholder="Keterangan..."></div></div>
       <div class="attendance-item"><label>Nur Cahyawati:</label><div class="input-group"><select id="selectNurCahyawati"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputNurCahyawati" class="custom-input" placeholder="Keterangan..."></div></div>
       <div class="attendance-item"><label>Supitri Ningsih:</label><div class="input-group"><select id="selectSupitriNingsih"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputSupitriNingsih" class="custom-input" placeholder="Keterangan..."></div></div>
       <div class="attendance-item"><label>Wahyu Nico U:</label><div class="input-group"><select id="selectWahyuNicoU"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputWahyuNicoU" class="custom-input" placeholder="Keterangan..."></div></div>
       <div class="attendance-item"><label>Yhoga:</label><div class="input-group"><select id="selectYhoga"><option value=""></option><option value="✓" selected>✓</option><option value="Cuti">Cuti</option><option value="Izin Sakit">Izin Sakit</option><option value="Masuk 12.00-21.00">Masuk 12.00-21.00</option></select><input type="text" id="inputYhoga" class="custom-input" placeholder="Keterangan..."></div></div>
    </div>
    <button onclick="submitAttendanceData()">Kirim Data Kehadiran</button>
  </div>
  
  <div class="data-actions">
      <button onclick="displaySheetData()">🔄 Tampilkan Data</button>
      <button onclick="renderTableToImage()">🖼️ Simpan Gambar</button>
  </div>

  <div class="card">
    <h2>Hapus Data Terakhir</h2>
    <div class="delete-section">
      <label for="deleteRowCount">Pilih jumlah baris yang akan dihapus:</label>
      <select id="deleteRowCount">
        <option value="1">1 baris</option><option value="2">2 baris</option>
        <option value="3">3 baris</option><option value="4">4 baris</option>
        <option value="5">5 baris</option><option value="6">6 baris</option>
        <option value="7">7 baris</option>
      </select>
      <button onclick="confirmDelete()" class="delete-btn">Hapus Baris Terpilih</button>
    </div>
  </div>

  <p id="loading">Memuat data...</p>
  <p id="error"></p>

  <div class="card">
      <h2 style="text-align: center; border: none; font-size: 1.5em;">📊 Data Kehadiran TMS Online</h2>
      <div id="tableWrapper">
        <div id="tableContainer"></div>
      </div>
  </div>
  
  <div id="imageContainer" style="margin-top: 20px;"></div>
</div>

<script>
  // --- Modifikasi Fungsi displaySheetData untuk Tabel Responsif ---
  function displaySheetData() {
    const loadingMessage = document.getElementById('loading');
    const errorMessage = document.getElementById('error');
    const tableContainer = document.getElementById('tableContainer');
    const imageContainer = document.getElementById('imageContainer');
    imageContainer.innerHTML = '';

    loadingMessage.style.display = 'block';
    errorMessage.textContent = '';
    tableContainer.innerHTML = '';

    google.script.run
      .withSuccessHandler(function(dataString) {
        loadingMessage.style.display = 'none';
        const data = JSON.parse(dataString);

        if (data.error) {
          errorMessage.textContent = 'Error: ' + data.error;
          return;
        }

        if (data.length <= 1) {
          tableContainer.innerHTML = '<p>Tidak ada data ditemukan (setelah header).</p>';
          return;
        }

        let tableHtml = '<table><thead><tr>';
        const headers = data[0];
        headers.forEach(header => {
          tableHtml += `<th>${header}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';

        const startIndex = Math.max(1, data.length - 7);

        for (let i = startIndex; i < data.length; i++) {
          let rowClass = '';
          if (data[i].length > 0) {
            try {
              const date = new Date(data[i][0]);
              if (!isNaN(date.getTime()) && date.getDay() === 0) {
                rowClass = 'sunday-row';
              }
            } catch (e) { /* Abaikan error parsing tanggal */ }
          }

          tableHtml += `<tr class="${rowClass}">`;
          data[i].forEach((cell, colIndex) => {
            let cellContent = cell;
            if (colIndex === 0) {
              try {
                const date = new Date(cell);
                if (!isNaN(date.getTime())) {
                  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                  cellContent = date.toLocaleDateString('id-ID', options);
                }
              } catch (e) { /* Biarkan konten sel asli */ }
            }
            // *** PENAMBAHAN PENTING: Menambahkan atribut data-label untuk CSS ***
            tableHtml += `<td data-label="${headers[colIndex]}">${cellContent}</td>`;
          });
          tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';
        tableContainer.innerHTML = tableHtml;
      })
      .withFailureHandler(function(error) {
        loadingMessage.style.display = 'none';
        errorMessage.textContent = 'Gagal memuat data: ' + error.message;
      })
      .getSheetData();
  }

  // --- Fungsi Lainnya (Tidak ada perubahan, tetap sama) ---
  
  function renderTableToImage() {
    const tableWrapper = document.getElementById('tableWrapper');
    const imageContainer = document.getElementById('imageContainer');

    // Sembunyikan header asli pada mode mobile saat mengambil gambar
    const isMobileView = window.innerWidth <= 768;
    const thead = tableWrapper.querySelector('thead');
    if (isMobileView && thead) thead.style.display = 'none';

    html2canvas(tableWrapper, {
        scale: 2, // Meningkatkan resolusi gambar
        useCORS: true,
        onclone: (document) => {
            // Saat mengkloning DOM, pastikan tr tidak lagi di-override oleh media query
            // Hal ini memastikan tabel tradisional dirender di canvas
            const clonedTable = document.querySelector('table');
            if(clonedTable){
                Array.from(clonedTable.querySelectorAll('tr, th, td, thead, tbody')).forEach(el => el.style.display = '');
                document.querySelector('thead').style.position = 'relative';
                document.querySelector('thead').style.top = '0';
                document.querySelector('thead').style.left = '0';
            }
        }
    }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = imgData;
      img.style.maxWidth = '100%';
      img.style.borderRadius = 'var(--border-radius)';
      img.style.boxShadow = 'var(--card-shadow)';
      
      imageContainer.innerHTML = '<h3>Hasil Gambar:</h3>';
      imageContainer.appendChild(img);
      
      if (isMobileView && thead) thead.style.display = ''; // Kembalikan thead
    });
  }

  function submitAttendanceData() {
    const dateInput = document.getElementById('attendanceDate');
    const selectedDate = dateInput.value;
    if (!selectedDate) {
      alert('Mohon pilih tanggal terlebih dahulu.');
      return;
    }
    function getValue(selectId, inputId) {
      const customValue = document.getElementById(inputId).value.trim();
      return customValue !== '' ? customValue : document.getElementById(selectId).value;
    }
    const attendanceData = {
      date: selectedDate,
      AndiPrasetyo: getValue('selectAndiPrasetyo', 'inputAndiPrasetyo'),
      AstriYuwana: getValue('selectAstriYuwana', 'inputAstriYuwana'),
      FrediPradopo: getValue('selectFrediPradopo', 'inputFrediPradopo'),
      KevinHaikal: getValue('selectKevinHaikal', 'inputKevinHaikal'),
      LailiAsmita: getValue('selectLailiAsmita', 'inputLailiAsmita'),
      MerryAriestaP: getValue('selectMerryAriestaP', 'inputMerryAriestaP'),
      NurCahyawati: getValue('selectNurCahyawati', 'inputNurCahyawati'),
      SupitriNingsih: getValue('selectSupitriNingsih', 'inputSupitriNingsih'),
      WahyuNicoU: getValue('selectWahyuNicoU', 'inputWahyuNicoU'),
      Yhoga: getValue('selectYhoga', 'inputYhoga')
    };
    google.script.run
      .withSuccessHandler(function(response) {
        if (response.success) {
          alert('Data kehadiran berhasil disimpan!');
          dateInput.value = '';
          document.querySelectorAll('.attendance-item select').forEach(select => select.value = '✓');
          document.querySelectorAll('.custom-input').forEach(input => input.value = '');
          displaySheetData();
        } else {
          alert('Gagal menyimpan data: ' + response.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Terjadi kesalahan saat mengirim data: ' + error.message);
      })
      .appendAttendanceData(attendanceData);
  }

  function confirmDelete() {
    const countElement = document.getElementById('deleteRowCount');
    const numberOfRows = parseInt(countElement.value, 10);
    if (!confirm('Anda yakin ingin menghapus ' + numberOfRows + ' baris terakhir? Tindakan ini tidak dapat dibatalkan.')) {
      return;
    }
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').textContent = '';
    google.script.run
      .withSuccessHandler(function(response) {
        document.getElementById('loading').style.display = 'none';
        alert(response.message);
        if (response.success) {
          displaySheetData();
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = 'Gagal menghapus baris: ' + error.message;
      })
      .deleteLastRows(numberOfRows);
  }

  // Tampilkan data saat halaman pertama kali dimuat
  document.addEventListener('DOMContentLoaded', displaySheetData);
</script>

</body>
</html>