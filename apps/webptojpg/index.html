<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebP → JPG Converter (Batch, Client-side)</title>
  <style>
    :root{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{max-width:900px;margin:32px auto;padding:20px;color:#111}
    h1{font-size:20px;margin-bottom:6px}
    p.lead{color:#444;margin-top:0}
    .card{border:1px solid #e6e6e6;border-radius:12px;padding:18px;margin-top:12px;box-shadow:0 6px 18px rgba(20,20,20,0.03)}
    .drop{border:2px dashed #cfcfcf;border-radius:10px;padding:26px;text-align:center;cursor:pointer}
    .drop.dragover{border-color:#6aa0ff;background:#f6fbff}
    input[type=file]{display:none}
    .files{margin-top:14px}
    .file-item{display:flex;align-items:center;gap:12px;padding:8px 6px;border-bottom:1px solid #f0f0f0}
    .thumb{width:64px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
    .meta{flex:1}
    .controls{display:flex;gap:12px;align-items:center;margin-top:12px}
    .btn{background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.secondary{background:#6b7280}
    progress{width:100%}
    label{font-size:13px;color:#333}
    small{color:#666}
  </style>
</head>
<body>
  <h1>WebP → JPG Converter (Batch)</h1>
  <p class="lead">Gambar diproses di lokal tidak dikirim ke server</p>

  <div class="card">
    <div id="drop" class="drop">Tarik & jatuhkan file .webp di sini, atau <button id="chooseBtn" class="btn secondary">Pilih file</button></div>
    <input id="fileInput" type="file" accept="image/webp,image/*" multiple />

    <div class="controls">
      <label>Quality: <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.9" /></label>
      <span id="qval">0.90</span>
      <label style="margin-left:12px">Nama hasil (pattern): <input id="pattern" type="text" placeholder="{name}.jpg or {name}_converted.jpg" value="{name}.jpg" /></label>
      <button id="convert" class="btn" style="margin-left:auto">Convert & Download ZIP</button>
    </div>

    <div id="files" class="files"></div>
    <div style="margin-top:12px"><progress id="prog" value="0" max="100" style="display:none"></progress></div>
    <p style="margin-top:10px"><small>Catatan: Browser modern mendukung WebP. Jika file bukan WebP, converter tetap mencoba mengonversinya. Semua proses dilakukan secara lokal.</small></p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const filesDiv = document.getElementById('files');
    const convertBtn = document.getElementById('convert');
    const quality = document.getElementById('quality');
    const qval = document.getElementById('qval');
    const prog = document.getElementById('prog');
    const pattern = document.getElementById('pattern');

    let fileList = [];

    function humanSize(n){
      if(n<1024) return n+' B';
      if(n<1024*1024) return (n/1024).toFixed(1)+' KB';
      return (n/1024/1024).toFixed(2)+' MB';
    }

    function renderFiles(){
      filesDiv.innerHTML='';
      fileList.forEach((f, i)=>{
        const el = document.createElement('div'); el.className='file-item';
        const img = document.createElement('img'); img.className='thumb'; img.src = f.preview;
        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = `<div><strong>${f.name}</strong> <small>(${humanSize(f.size)})</small></div><div><small>${f.type || ''}</small></div>`;
        const rem = document.createElement('button'); rem.className='btn secondary'; rem.textContent='Hapus';
        rem.onclick = ()=>{ fileList.splice(i,1); renderFiles(); }
        el.appendChild(img); el.appendChild(meta); el.appendChild(rem);
        filesDiv.appendChild(el);
      });
      if(fileList.length===0) filesDiv.innerHTML='<p><small>Belum ada file.</small></p>';
    }

    async function handleFiles(inFiles){
      const arr = Array.from(inFiles);
      for(const f of arr){
        // create preview
        const obj = {file: f, name: f.name.replace(/\.webp$/i,'').replace(/\.[^.]+$/,'').trim(), size: f.size, type: f.type};
        obj.preview = URL.createObjectURL(f);
        fileList.push(obj);
      }
      renderFiles();
    }

    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', ()=>{ drop.classList.remove('dragover'); });
    drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    chooseBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', (e)=>handleFiles(e.target.files));

    quality.addEventListener('input', ()=>{ qval.textContent = Number(quality.value).toFixed(2); });

    function applyPattern(name){
      const pat = pattern.value || '{name}.jpg';
      return pat.replace(/\{name\}/gi, name);
    }

    async function convertOne(item){
      // read file into ImageBitmap for reliability
      const blob = item.file;
      try{
        const bitmap = await createImageBitmap(blob);
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap,0,0);
        const qualityVal = Number(quality.value);
        const jpegBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', qualityVal));
        return jpegBlob;
      }catch(err){
        // fallback using Image
        return new Promise((resolve,reject)=>{
          const img = new Image();
          img.onload = ()=>{
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img,0,0);
            canvas.toBlob(b=>resolve(b),'image/jpeg',Number(quality.value));
          };
          img.onerror = (e)=>reject(e);
          img.src = URL.createObjectURL(blob);
        });
      }
    }

    convertBtn.addEventListener('click', async ()=>{
      if(fileList.length===0){ alert('Pilih file terlebih dahulu.'); return; }
      convertBtn.disabled = true; convertBtn.textContent='Converting...';
      prog.style.display='block'; prog.value = 0; prog.max = fileList.length;

      const zip = new JSZip();
      let i=0;
      for(const item of fileList){
        try{
          const outBlob = await convertOne(item);
          const outName = applyPattern(item.name);
          zip.file(outName, outBlob);
        }catch(err){
          console.error('Konversi gagal untuk', item.name, err);
        }
        i++; prog.value = i;
      }

      prog.style.display='none';
      prog.value = 0;

      convertBtn.textContent = 'Mempersiapkan ZIP...';
      const content = await zip.generateAsync({type:'blob'});
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url; a.download = 'webp-to-jpg.zip';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);

      convertBtn.disabled = false; convertBtn.textContent='Convert & Download ZIP';
    });

    // initial state
    renderFiles();
  </script>
</body>
</html>